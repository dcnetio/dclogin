server {
    # 1. 监听 3000
    listen 3000;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;

    # === Headers ===
    add_header X-Frame-Options "ALLOWALL" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "origin-when-cross-origin" always;

    # ==========================================
    # 规则 1: 访问 /iframe -> 转发到 5174 的根目录 /
    # ==========================================
    # 注意：这里不能用正则(~)，必须用前缀匹配
    location /iframe {
        # 关键点：5174 后面加了斜杠 /
        # 这意味着：请求 /iframe/foo -> 变成 /foo 发给 5174
        proxy_pass http://127.0.0.1:5174/; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # WebSocket 支持 (Vite HMR 需要)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ==========================================
    # 规则 2: 访问 /iframe/ -> 兼容带斜杠的情况
    # ==========================================
    # 有时候浏览器会自动补全斜杠，或者代码里写了斜杠
    # 这个 location 可以和上面合并，但为了稳妥起见，单独写一个显式规则
    location = /iframe/ {
        proxy_pass http://127.0.0.1:5174/;
    }

    # ==========================================
    # 规则 3: 静态资源透传 (保持路径不变)
    # ==========================================
    # 当 5174 的页面加载后，会请求 /@vite/client, /src/main.ts, /assets/xxx.js
    # 这些请求没有 /iframe 前缀，需要原样转发
    location ~ ^/(@vite|src|node_modules|assets|public) {
        # 注意：这里 5174 后面【不要】加斜杠
        # 意味着：请求 /assets/a.js -> 还是 /assets/a.js 发给 5174
        proxy_pass http://127.0.0.1:5174;
        
        proxy_set_header Host $host;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ==========================================
    # 规则 4: 默认路由 (3000 端口自己的内容)
    # ==========================================
    location / {
        try_files $uri $uri.html $uri/ /index.html;
    }
}